<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gold Decision Radar — Market Panel</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    .wrap { max-width: 880px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .status { font-size: 13px; margin: 8px 0 14px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { grid-column: span 12; border: 1px solid #ddd; border-radius: 12px; padding: 12px 12px 10px; }
    @media (min-width: 740px) { .card { grid-column: span 6; } }
    label { display: block; font-size: 12px; opacity: .8; margin-bottom: 6px; }
    input, select, button {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 14px;
    }
    input[readonly] { background: #fafafa; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .meta { font-size: 12px; opacity: .7; margin-top: 8px; line-height: 1.35; }
    .btnrow { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 740px) { .btnrow { grid-template-columns: 1fr 1fr 1fr; } }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Gold Decision Radar — Market (Auto)</h1>
    <div class="status" id="status">Status: idle</div>

    <div class="btnrow">
      <button id="btnFetch" type="button">Fetch now</button>
      <button id="btnStart" type="button">Start auto (60s)</button>
      <button id="btnStop" type="button">Stop auto</button>
    </div>

    <div class="meta">
      API: <span class="pill">/api/market</span> (front-end reads: <span class="pill">SETFGOLD price</span>, <span class="pill">RSI</span>, <span class="pill">USD/INR</span>, <span class="pill">DXY</span>, <span class="pill">Real Yield</span>)
    </div>

    <div class="grid" style="margin-top:14px;">
      <div class="card">
        <label for="setfGoldPrice">SETFGOLD Market Price (₹)</label>
        <input id="setfGoldPrice" readonly placeholder="—" />
        <div class="meta">From: <span class="pill">setfGoldPrice</span></div>
      </div>

      <div class="card">
        <label for="rsi14">RSI(14) — SETFGOLD</label>
        <input id="rsi14" readonly placeholder="—" />
        <div class="meta">From: <span class="pill">rsi14Setfgold</span></div>
      </div>

      <div class="card">
        <label for="usdInr">USD/INR Spot</label>
        <input id="usdInr" readonly placeholder="—" />
        <div class="meta">
          From: <span class="pill">usdInr</span>
          &nbsp;| 30d%: <span id="usdInr30d" class="pill">—</span>
          &nbsp;| Trend: <span id="usdInrTrend" class="pill">—</span>
        </div>
      </div>

      <div class="card">
        <label for="dxy">DXY</label>
        <input id="dxy" readonly placeholder="—" />
        <div class="meta">From: <span class="pill">dxy</span></div>
      </div>

      <div class="card">
        <label for="realYield">US 10Y Real Yield</label>
        <input id="realYield" readonly placeholder="—" />
        <div class="meta">From: <span class="pill">realYield</span> (FRED DFII10)</div>
      </div>

      <div class="card">
        <label for="asOf">As of (API)</label>
        <input id="asOf" readonly placeholder="—" />
        <div class="meta">
          Errors: <span id="errCount" class="pill">0</span>
          <div id="errList" class="meta" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tiny helper
    const $ = (id) => document.getElementById(id);

    // --- AutoFetch: ONLY these 5 values ---
    // Reads: setfGoldPrice, rsi14Setfgold, usdInr, dxy, realYield
    async function autoFetch({ inavOff = true } = {}) {
      const statusEl = $("status");

      const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg; };

      const setField = (id, value) => {
        const el = $(id);
        if (!el) return;
        if ("value" in el) el.value = value;
        else el.textContent = value;
      };

      const fmt = { num: (v, digits) => (Number.isFinite(v) ? v.toFixed(digits) : "—") };

      setStatus("Status: fetching…");

      try {
        const endpoint = inavOff ? "/api/market?inav=off" : "/api/market";
        const res = await fetch(endpoint, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        // Parse & guard
        const setfGoldPrice = Number(data?.setfGoldPrice);
        const rsi14 = Number(data?.rsi14Setfgold);
        const usdInr = Number(data?.usdInr);
        const dxy = Number(data?.dxy);
        const realYield = Number(data?.realYield);

        // Write ONLY these 5 to main inputs
        setField("setfGoldPrice", fmt.num(setfGoldPrice, 2));
        setField("rsi14", fmt.num(rsi14, 1));
        setField("usdInr", fmt.num(usdInr, 4));
        setField("dxy", fmt.num(dxy, 2));
        setField("realYield", fmt.num(realYield, 2));

        // Optional supporting display (still aligned with market.js response)
        setField("usdInr30d", Number.isFinite(Number(data?.usdInrChangePct30d)) ? `${Number(data.usdInrChangePct30d).toFixed(2)}%` : "—");
        setField("usdInrTrend", data?.usdInrTrend ? String(data.usdInrTrend) : "—");

        setField("asOf", data?.asOf ? String(data.asOf) : "—");

        const errors = Array.isArray(data?.errors) ? data.errors : [];
        setField("errCount", String(errors.length));

        const errListEl = $("errList");
        if (errListEl) {
          errListEl.innerHTML = errors.length
            ? "<b>Warnings:</b><ul style='margin:6px 0 0 18px; padding:0;'>" +
              errors.map(e => `<li>${escapeHtml(String(e))}</li>`).join("") +
              "</ul>"
            : "";
        }

        setStatus(errors.length ? `Status: fetched (with ${errors.length} warning${errors.length > 1 ? "s" : ""})` : "Status: fetched ✅");
      } catch (e) {
        console.error("autoFetch error:", e);
        setStatus(`Status: fetch failed ❌ (${String(e?.message || e)})`);
      }
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    // Optional polling wrapper
    let _autoFetchTimer = null;

    function startAutoFetch(intervalMs = 60000, opts = { inavOff: true }) {
      stopAutoFetch();
      autoFetch(opts); // immediate
      _autoFetchTimer = setInterval(() => autoFetch(opts), intervalMs);
    }

    function stopAutoFetch() {
      if (_autoFetchTimer) clearInterval(_autoFetchTimer);
      _autoFetchTimer = null;
    }

    // Wire buttons
    $("btnFetch").addEventListener("click", () => autoFetch({ inavOff: true }));
    $("btnStart").addEventListener("click", () => startAutoFetch(60000, { inavOff: true }));
    $("btnStop").addEventListener("click", () => stopAutoFetch());

    // Optional: auto start once on load
    autoFetch({ inavOff: true });
  </script>
</body>
</html>
